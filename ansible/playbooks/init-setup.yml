---
- name: Initial setup of raspberry pis
  hosts: init-setup-required

  vars_prompt:
    - name: network_ssid
      prompt: "What is the wifi network name (SSID)?"
      private: no
    - name: network_psk
      prompt: "What is the wifi network password (PSK)?"

  vars:
    desired_timezone: "US/Eastern"
    # locale values can be found in /usr/share/i18n/SUPPORTED
    desired_iso_country: "US"
    desired_keyboard_layout: "en"
    desired_language: "en"
    desired_encoding: "UTF-8"
    desired_locale: "en_US"
    desired_locale_short: "{{ desired_locale.split()[0] }}"

  tasks:
    - debug: var=desired_locale_short
    - name: Check if we need to resize FS
      stat:
        path: /etc/init.d/resize2fs_once
      register: file_created_by_expand_rootfs
    - name: Ensures root FS is resized
      become: true
      command: raspi-config --expand-rootfs
      when: file_created_by_expand_rootfs.stat.exists == false
      notify:
        - reboot

    - name: Sets the timezone
      timezone:
        name: "{{ desired_timezone }}"

    - name: Unsets default GB locale
      become: true
      replace:
        path: /etc/locale.gen
        regexp: "^en_GB.UTF-8 UTF-8"
        replace: "# en_GB.UTF-8 UTF-8"
    - name: Sets target locale to generate locale files from
      become: true
      replace:
        path: /etc/locale.gen
        regexp: '# {{ desired_locale }}.{{ desired_encoding }} {{ desired_encoding }}'
        replace: "{{ desired_locale }}"
    - name: Sets the default locale
      become: true
      blockinfile:
        path: /etc/default/locale
        block: |
          LANG="{{ desired_locale }}.{{ desired_encoding }}"
          LANGUAGE="{{ desired_locale }}:{{ desired_language  }}"

    - name: Update WPA config with ISO country code
      become: true
      lineinfile:
        path: /etc/wpa_supplicant/wpa_supplicant.conf
        regexp: '^country='
        line: "country={{ desired_iso_country }}"
    - name: Setup pi onto target network
      become: true
      blockinfile:
        path: /etc/wpa_supplicant/wpa_supplicant.conf
        block: |
          network={
            ssid="{{ network_ssid }}"
            psk="{{ network_psk }}"
          }

  handlers:
    - name: reboot
      shell: "sleep 1 && shutdown -r now +1"
      async: 1
      poll: 0
      notify:
        - wait for reboot
    - name: wait for reboot
      wait_for_connection:
        delay: 5
        timeout: 300

